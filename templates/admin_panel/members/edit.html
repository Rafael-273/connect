{% extends 'admin_base.html' %}
{% load static %}

{% block title %}{% if member %}Editar Membro{% else %}Novo Membro{% endif %} - Painel Administrativo{% endblock %}

{% block head %}
<style>
    body {
        background-color: #f8f9fa !important;
    }
    
    .admin-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    .sidebar {
        background: white;
        min-height: 100vh;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #64748b;
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }
    
    .sidebar-item:hover, .sidebar-item.active {
        background-color: #f1f5f9;
        color: var(--color-primary);
        border-left-color: var(--color-primary);
        text-decoration: none;
    }
    
    .sidebar-item ion-icon {
        font-size: 20px;
        margin-right: 12px;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(201, 9, 5, 0.1);
    }
    
    .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        background-color: white;
        transition: border-color 0.2s;
    }
    
    .form-select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(201, 9, 5, 0.1);
    }
    
    .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        resize: vertical;
        min-height: 100px;
        transition: border-color 0.2s;
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(201, 9, 5, 0.1);
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
$(document).ready(function() {
    $('#ministry-select').select2({
        placeholder: 'Selecione os Ministérios',
        width: '100%',
        allowClear: true,
        language: {
            noResults: function() {
                return "Nenhum ministério encontrado";
            }
        }
    });
    if (typeof $ === 'function' && $.fn.mask) {
        $('input[name="phone"]').mask('(00) 00000-0000');
    }
});
</script>
{% endblock %}

{% block content %}
{% include 'parciais/messages.html' %}

<div class="flex min-h-screen bg-gray-50">
    {% include 'parciais/admin_sidebar.html' %}

    <div class="flex-1 ml-64">
        <div class="p-6 mt-24">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        {% if member %}Editar Membro{% else %}Novo Membro{% endif %}
                    </h1>
                    <p class="text-gray-600 mt-2">
                        {% if member %}Atualizar informações do membro{% else %}Adicionar novo membro à igreja{% endif %}
                    </p>
                </div>
                <a href="{% url 'admin_members_list' %}" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition flex items-center">
                    <ion-icon name="arrow-back" class="mr-2"></ion-icon>
                    Voltar à Lista
                </a>
            </div>

            <div class="admin-card p-8">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" name="name" value="{{ member.name|default:'' }}" 
                                   class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" value="{{ member.email|default:'' }}" 
                                   class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input type="text" name="phone" value="{{ member.phone|default:'' }}" 
                                   class="form-input" placeholder="(11) 99999-9999">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" name="birth_date" 
                                   value="{% if member.birth_date %}{{ member.birth_date|date:'Y-m-d' }}{% endif %}" 
                                   class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Gênero</label>
                            <select name="gender" class="form-select">
                                <option value="">Selecionar...</option>
                                <option value="male" {% if member.gender == 'male' %}selected{% endif %}>Masculino</option>
                                <option value="female" {% if member.gender == 'female' %}selected{% endif %}>Feminino</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Estado Civil</label>
                            <select name="marital_status" class="form-select">
                                <option value="">Selecionar...</option>
                                <option value="single" {% if member.marital_status == 'single' %}selected{% endif %}>Solteiro(a)</option>
                                <option value="married" {% if member.marital_status == 'married' %}selected{% endif %}>Casado(a)</option>
                                <option value="divorced" {% if member.marital_status == 'divorced' %}selected{% endif %}>Divorciado(a)</option>
                                <option value="widowed" {% if member.marital_status == 'widowed' %}selected{% endif %}>Viúvo(a)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ministério</label>
                            <select name="ministry" id="ministry-select" multiple class="form-select">
                                {% for ministry in ministries %}
                                <option value="{{ ministry.id }}" {% if member and ministry in member.ministry.all %}selected{% endif %}>{{ ministry.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-gray-500">Segure Ctrl (Windows) ou Command (Mac) para selecionar mais de um.</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Bairro</label>
                            <select name="neighborhood" class="form-select">
                                <option value="">Selecionar...</option>
                                {% for neighborhood in neighborhoods %}
                                <option value="{{ neighborhood.id }}" {% if member.neighborhood_id == neighborhood.id %}selected{% endif %}>
                                    {{ neighborhood.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tipo de Conversão</label>
                            <select name="conversion" class="form-select">
                                <option value="">Selecionar...</option>
                                <option value="new_convert" {% if member.conversion == 'new_convert' %}selected{% endif %}>Novo Convertido</option>
                                <option value="reconciled" {% if member.conversion == 'reconciled' %}selected{% endif %}>Reconciliado</option>
                                <option value="from_another_church" {% if member.conversion == 'from_another_church' %}selected{% endif %}>Vindo de outra Igreja</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Data da Conversão</label>
                            <input type="date" name="conversion_date" 
                                   value="{% if member.conversion_date %}{{ member.conversion_date|date:'Y-m-d' }}{% endif %}" 
                                   class="form-input">
                        </div>
                        
                        <!-- Removidos: Tags, Cônjuge, Tipo de Personalidade, Dias disponíveis, Interesses/Habilidades, Desafios Iniciais -->
                        <!-- Os campos removidos estavam aqui -->
                    </div>
                    
                    <!-- Endereço -->
                    <div class="form-group">
                        <label class="form-label">Endereço Completo</label>
                        <input type="text" name="address" value="{{ member.address|default:'' }}" 
                               class="form-input" placeholder="Rua, número, bairro, cidade">
                    </div>
                    
                    <!-- Foto de Perfil -->
                    <div class="form-group">
                        <label class="form-label">Foto de Perfil</label>
                        {% if member.profile_picture %}
                        <div class="mb-4">
                            <img src="{{ member.profile_picture.url }}" alt="{{ member.name }}" 
                                 class="w-20 h-20 rounded-full object-cover border-2 border-gray-300">
                            <p class="text-sm text-gray-600 mt-2">Foto atual</p>
                        </div>
                        {% endif %}
                        <input type="file" name="profile_picture" class="form-input" accept="image/*">
                        <p class="text-xs text-gray-500 mt-1">Formatos aceitos: JPG, PNG. Tamanho máximo: 5MB</p>
                    </div>
                    
                    <!-- Testemunho -->
                    <div class="form-group">
                        <label class="form-label">Testemunho</label>
                        <textarea name="testimony" class="form-textarea" 
                                  placeholder="Compartilhe o testemunho do membro...">{{ member.testimony|default:'' }}</textarea>
                    </div>
                    
                    <!-- Agrupar todos os checkboxes no final -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <div class="flex items-center">
                                <input type="checkbox" name="is_active" 
                                       {% if member.is_active or not member %}checked{% endif %}
                                       class="form-checkbox h-5 w-5 text-[var(--color-primary)] rounded border-gray-300 focus:ring-[var(--color-primary)]">
                                <label class="ml-2 text-sm text-gray-700">Membro ativo</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Disponível para consolidar?</label>
                            <div class="flex items-center">
                                <input type="checkbox" name="is_available_to_consolidate" {% if member.is_available_to_consolidate %}checked{% endif %} class="form-checkbox h-5 w-5 text-[var(--color-primary)]">
                                <label class="ml-2 text-sm text-gray-700">Sim</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Disponível para discipular?</label>
                            <div class="flex items-center">
                                <input type="checkbox" name="is_available_to_disciple" {% if member.is_available_to_disciple %}checked{% endif %} class="form-checkbox h-5 w-5 text-[var(--color-primary)]">
                                <label class="ml-2 text-sm text-gray-700">Sim</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botões -->
                    <div class="flex justify-end space-x-4 mt-8">
                        <a href="{% url 'admin_members_list' %}" 
                           class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                            Cancelar
                        </a>
                        <button type="submit" 
                                class="px-6 py-3 bg-[var(--color-primary)] text-white rounded-lg hover:bg-opacity-90 transition">
                            {% if member %}Atualizar Membro{% else %}Criar Membro{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
