{% extends 'admin_base.html' %}
{% load static %}

{% block title %}{% if visitor %}Editar Visitante{% else %}Novo Visitante{% endif %} - Painel Administrativo{% endblock %}

{% block head %}
<!-- SweetAlert2 for better alerts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    body {
        background-color: #f8f9fa !important;
    }
    
    .admin-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    .sidebar {
        background: white;
        min-height: 100vh;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #64748b;
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }
    
    .sidebar-item:hover, .sidebar-item.active {
        background-color: #f1f5f9;
        color: var(--color-primary);
        border-left-color: var(--color-primary);
        text-decoration: none;
    }
    
    .sidebar-item ion-icon {
        font-size: 20px;
        margin-right: 12px;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(201, 9, 5, 0.1);
    }
    
    .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        background-color: white;
        transition: border-color 0.2s;
    }
    
    .form-select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(201, 9, 5, 0.1);
    }
    
    .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        resize: vertical;
        min-height: 100px;
        transition: border-color 0.2s;
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(201, 9, 5, 0.1);
    }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .checkbox-input {
        width: 1.25rem;
        height: 1.25rem;
        accent-color: var(--color-primary);
    }
</style>
{% endblock %}

{% block content %}
<!-- Include messages component -->
{% include 'parciais/messages.html' %}

<div class="flex min-h-screen bg-gray-50">
    <!-- Sidebar -->
    {% include 'parciais/admin_sidebar.html' %}

    <!-- Main Content -->
    <div class="flex-1 ml-64">
        <div class="p-6 mt-24">
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        {% if visitor %}Editar Visitante{% else %}Novo Visitante{% endif %}
                    </h1>
                    <p class="text-gray-600 mt-2">
                        {% if visitor %}Atualizar informações do visitante{% else %}Registrar novo visitante da igreja{% endif %}
                    </p>
                    
                    <!-- Indicador de Conversão -->
                    {% if visitor and visitor.profile_notes and '[CONVERTIDO]' in visitor.profile_notes %}
                    <div class="mt-3 p-3 bg-green-100 border border-green-400 rounded-lg flex items-center">
                        <ion-icon name="checkmark-circle" class="text-green-600 text-xl mr-2"></ion-icon>
                        <div>
                            <span class="text-green-800 font-semibold">✅ Visitante já convertido para membro!</span>
                            <p class="text-green-700 text-sm mt-1">Este visitante foi automaticamente migrado para a lista de membros.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <a href="{% url 'admin_visitors_list' %}" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition flex items-center">
                    <ion-icon name="arrow-back" class="mr-2"></ion-icon>
                    Voltar à Lista
                </a>
            </div>

            <!-- Messages -->
            {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} p-4 rounded-lg mb-4 flex items-center
                    {% if message.tags == 'success' %}bg-green-100 border border-green-400 text-green-800
                    {% elif message.tags == 'error' %}bg-red-100 border border-red-400 text-red-800
                    {% elif message.tags == 'warning' %}bg-yellow-100 border border-yellow-400 text-yellow-800
                    {% else %}bg-blue-100 border border-blue-400 text-blue-800{% endif %}">
                    <ion-icon name="
                        {% if message.tags == 'success' %}checkmark-circle
                        {% elif message.tags == 'error' %}close-circle
                        {% elif message.tags == 'warning' %}warning
                        {% else %}information-circle{% endif %}" class="text-xl mr-3"></ion-icon>
                    <span>{{ message }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Form -->
            <div class="admin-card p-8">
                <form method="POST">
                    {% csrf_token %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Informações Básicas -->
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" name="name" value="{{ visitor.name|default:'' }}" 
                                   class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" value="{{ visitor.email|default:'' }}" 
                                   class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input type="text" name="phone" value="{{ visitor.phone|default:'' }}" 
                                   class="form-input" placeholder="(11) 99999-9999">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Data da Visita *</label>
                            <input type="date" name="visit_date" 
                                   value="{% if visitor.visit_date %}{{ visitor.visit_date|date:'Y-m-d' }}{% endif %}" 
                                   class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Gênero</label>
                            <select name="gender" class="form-select">
                                <option value="">Selecionar...</option>
                                <option value="male" {% if visitor.gender == 'male' %}selected{% endif %}>Masculino</option>
                                <option value="female" {% if visitor.gender == 'female' %}selected{% endif %}>Feminino</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Bairro</label>
                            <select name="neighborhood" class="form-select">
                                <option value="">Selecionar...</option>
                                {% for neighborhood in neighborhoods %}
                                <option value="{{ neighborhood.id }}" {% if visitor.neighborhood_id == neighborhood.id %}selected{% endif %}>
                                    {{ neighborhood.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Endereço -->
                    <div class="form-group">
                        <label class="form-label">Endereço Completo</label>
                        <input type="text" name="address" value="{{ visitor.address|default:'' }}" 
                               class="form-input" placeholder="Rua, número, bairro, cidade">
                    </div>
                    
                    <!-- Decisão por Jesus -->
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="decision_for_jesus" value="true" 
                                   {% if visitor.decision_for_jesus %}checked{% endif %}
                                   class="checkbox-input" id="decision_for_jesus">
                            <label for="decision_for_jesus" class="form-label mb-0">Fez decisão por Jesus?</label>
                        </div>
                    </div>
                    
                    <!-- Tipo de Conversão -->
                    <div class="form-group">
                        <label class="form-label">Tipo de Conversão</label>
                        <select name="conversion" class="form-select">
                            <option value="">Selecionar...</option>
                            <option value="new_convert" {% if visitor.conversion == 'new_convert' %}selected{% endif %}>Novo Convertido</option>
                            <option value="reconciled" {% if visitor.conversion == 'reconciled' %}selected{% endif %}>Reconciliado</option>
                            <option value="from_another_church" {% if visitor.conversion == 'from_another_church' %}selected{% endif %}>Vindo de outra Igreja</option>
                        </select>
                    </div>
                    
                    <!-- Pedido de Oração -->
                    <div class="form-group">
                        <label class="form-label">Pedido de Oração</label>
                        <textarea name="prayer_request" class="form-textarea" 
                                  placeholder="Descreva o pedido de oração do visitante...">{{ visitor.prayer_request|default:'' }}</textarea>
                    </div>
                    
                    <!-- Observações -->
                    <div class="form-group">
                        <label class="form-label">Observações/Anotações</label>
                        <textarea name="profile_notes" class="form-textarea" 
                                  placeholder="Adicione observações sobre o visitante...">{{ visitor.profile_notes|default:'' }}</textarea>
                    </div>
                    
                    <!-- Botões -->
                    <div class="flex justify-end space-x-4 mt-8">
                        <a href="{% url 'admin_visitors_list' %}" 
                           class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                            Cancelar
                        </a>
                        <button type="submit" 
                                class="px-6 py-3 bg-[var(--color-primary)] text-white rounded-lg hover:bg-opacity-90 transition">
                            {% if visitor %}Atualizar Visitante{% else %}Criar Visitante{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Controlar checkbox de decisão por Jesus e select de conversão
    const decisionCheckbox = document.getElementById('decision_for_jesus');
    const conversionSelect = document.querySelector('select[name="conversion"]');
    let originalDecisionState = decisionCheckbox.checked;
    let originalConversionState = conversionSelect.value;
    
    function checkConversionStatus() {
        const willConvert = decisionCheckbox.checked || conversionSelect.value;
        const wasConvertible = originalDecisionState || originalConversionState;
        
        if (willConvert && !wasConvertible) {
            const conversionType = conversionSelect.value || 'novo convertido';
            return confirm(
                '🎉 Que alegria! Este visitante será convertido!\n\n' +
                `Tipo de conversão: ${conversionType}\n\n` +
                'Ao confirmar, ele será automaticamente convertido para membro da igreja.\n\n' +
                'Deseja continuar?'
            );
        }
        return true;
    }
    
    decisionCheckbox.addEventListener('change', function() {
        if (this.checked && !originalDecisionState && !conversionSelect.value) {
            const confirmed = checkConversionStatus();
            if (!confirmed) {
                this.checked = false;
                return;
            }
        }
    });
    
    conversionSelect.addEventListener('change', function() {
        if (this.value && !originalConversionState && !decisionCheckbox.checked) {
            const confirmed = checkConversionStatus();
            if (!confirmed) {
                this.value = '';
                return;
            }
        }
    });
    
    // Auto-resize textareas
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });
    
    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const name = document.querySelector('input[name="name"]').value.trim();
        const visitDate = document.querySelector('input[name="visit_date"]').value;
        const email = document.querySelector('input[name="email"]').value.trim();
        
        if (!name) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Campo obrigatório',
                text: 'Por favor, preencha o nome do visitante.',
                confirmButtonColor: '#c90905'
            });
            document.querySelector('input[name="name"]').focus();
            return;
        }
        
        if (!visitDate) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Campo obrigatório',
                text: 'Por favor, preencha a data da visita.',
                confirmButtonColor: '#c90905'
            });
            document.querySelector('input[name="visit_date"]').focus();
            return;
        }
        
        // Validação básica de email
        if (email && !isValidEmail(email)) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Email inválido',
                text: 'Por favor, insira um email válido.',
                confirmButtonColor: '#c90905'
            });
            document.querySelector('input[name="email"]').focus();
            return;
        }
        
        // Confirmação final se será convertido
        const willConvert = decisionCheckbox.checked || conversionSelect.value;
        const wasConvertible = originalDecisionState || originalConversionState;
        
        if (willConvert && !wasConvertible) {
            e.preventDefault();
            const conversionType = conversionSelect.value || 'novo convertido';
            
            Swal.fire({
                title: '🎉 Conversão para Membro!',
                html: `
                    <div class="text-left">
                        <p><strong>Confirmação necessária:</strong></p>
                        <p>O visitante será convertido para membro como <span class="font-bold text-blue-600">${conversionType}</span>.</p>
                        <p class="mt-3">Esta ação irá:</p>
                        <ul class="list-disc list-inside mt-2 text-sm">
                            <li>Criar um novo membro na base de dados</li>
                            <li>Transferir todas as informações do visitante</li>
                            <li>Marcar o visitante como convertido</li>
                        </ul>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#22c55e',
                cancelButtonColor: '#ef4444',
                confirmButtonText: '✅ Sim, converter!',
                cancelButtonText: '❌ Cancelar',
                customClass: {
                    popup: 'swal-wide'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Usuário confirmou, submeter o formulário
                    e.target.submit();
                } else {
                    // Usuário cancelou, reverter mudanças
                    decisionCheckbox.checked = originalDecisionState;
                    conversionSelect.value = originalConversionState;
                }
            });
        }
    });
    
    // Função para validar email
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Mostrar alerta de conflito de email se existir
    {% if email_warning %}
    document.addEventListener('DOMContentLoaded', function() {
        const emailWarning = {{ email_warning|safe }};
        
        if (emailWarning.type === 'member_conflict') {
            Swal.fire({
                title: '⚠️ Conflito de Email Detectado',
                html: `
                    <div class="text-left">
                        <p><strong>Atenção:</strong></p>
                        <p>O email <span class="font-bold text-red-600">"${emailWarning.email}"</span> já pertence ao membro:</p>
                        <p class="font-bold text-blue-600 text-lg mt-2">"${emailWarning.member_name}"</p>
                        <p class="mt-3 text-sm text-gray-600">
                            <strong>Recomendação:</strong> Verifique se o visitante e o membro são a mesma pessoa para evitar duplicatas no sistema.
                        </p>
                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                            <p class="text-xs text-yellow-800">
                                <strong>Nota:</strong> O visitante será salvo normalmente, mas recomendamos verificar esta duplicata.
                            </p>
                        </div>
                    </div>
                `,
                icon: 'warning',
                confirmButtonColor: '#f59e0b',
                confirmButtonText: 'Entendi, continuar'
            });
        } else if (emailWarning.type === 'user_conflict' || emailWarning.type === 'general_conflict') {
            Swal.fire({
                title: '⚠️ Email já Registrado',
                html: `
                    <div class="text-left">
                        <p><strong>Atenção:</strong></p>
                        <p>O email <span class="font-bold text-red-600">"${emailWarning.email}"</span> já está registrado no sistema.</p>
                        <p class="mt-3 text-sm text-gray-600">
                            <strong>Recomendação:</strong> Verifique se não há duplicatas no sistema.
                        </p>
                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                            <p class="text-xs text-yellow-800">
                                <strong>Nota:</strong> O visitante será salvo normalmente, mas recomendamos verificar esta situação.
                            </p>
                        </div>
                    </div>
                `,
                icon: 'warning',
                confirmButtonColor: '#f59e0b',
                confirmButtonText: 'Entendi, continuar'
            });
        }
    });
    {% endif %}
</script>
{% endblock %}
